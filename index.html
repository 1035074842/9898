<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>战术小队H战队-OP打卡</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft YaHei", Arial, sans-serif; }
        body { background-color: #1a1a2e; color: #fff; min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: #16213e; border-radius: 16px; padding: 30px; box-shadow: 0 0 20px rgba(0,0,0,0.3); }
        .team-title { text-align: center; margin-bottom: 30px; font-size: 28px; color: #00ff9d; text-shadow: 0 0 8px rgba(0,255,157,0.5); }
        
        /* 打卡表单样式 */
        .checkin-form { display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-label { font-size: 18px; color: #e94560; }
        .form-input, .form-select { padding: 12px 16px; border-radius: 8px; border: none; font-size: 16px; background: #0f3460; color: #fff; }
        .form-input:disabled, .form-select:disabled { background: #2a4365; cursor: not-allowed; }
        .checkin-btn { padding: 14px; border-radius: 8px; border: none; background: #00ff9d; color: #1a1a2e; font-size: 18px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .checkin-btn:disabled { background: #00cc7f; cursor: not-allowed; }
        
        /* 历史记录控制区 */
        .record-control { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .view-record-btn { padding: 12px 24px; border-radius: 8px; border: none; background: #e94560; color: #fff; font-size: 16px; cursor: pointer; }
        .stat-btn { padding: 12px 24px; border-radius: 8px; border: none; background: #3a86ff; color: #fff; font-size: 16px; cursor: pointer; }
        
        /* 历史记录列表 */
        .record-list { max-height: 0; overflow: hidden; transition: max-height 0.5s ease; margin-top: 20px; background: #0f3460; border-radius: 8px; padding: 0 16px; }
        .record-list.show { max-height: 600px; padding: 16px; }
        .record-title { text-align: center; margin-bottom: 16px; font-size: 18px; color: #e94560; }
        
        /* 日期分组样式 */
        .date-group { margin-bottom: 20px; }
        .date-group-header { padding: 8px 12px; background: #16213e; border-radius: 6px; margin-bottom: 10px; font-weight: 600; color: #00ff9d; }
        .date-group-content { padding-left: 10px; }
        
        /* 单条记录样式 */
        .record-item { padding: 12px; border-bottom: 1px solid #2a4365; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .record-item:last-child { border-bottom: none; }
        .record-item:hover { background: #16213e; border-radius: 4px; }
        .record-name { font-size: 16px; }
        .record-time { font-size: 14px; color: #a0aec0; }
        
        /* 响应式适配 */
        @media (max-width: 600px) {
            .container { padding: 20px; }
            .team-title { font-size: 24px; }
            .form-label { font-size: 16px; }
            .checkin-btn, .view-record-btn, .stat-btn { font-size: 16px; padding: 10px 18px; }
            .record-control { flex-direction: column; gap: 10px; }
            .record-name { font-size: 14px; }
            .record-time { font-size: 12px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="team-title">战术小队 H战队 OP打卡</h1>
        
        <!-- 打卡表单 -->
        <div class="checkin-form">
            <div class="form-group">
                <label class="form-label" for="gameName">游戏名称</label>
                <input type="text" id="gameName" class="form-input" placeholder="请输入你的游戏ID" required>
            </div>
            <div class="form-group">
                <label class="form-label" for="checkinMap">打卡地图</label>
                <select id="checkinMap" class="form-select" required>
                    <option value="">请选择本次OP打卡地图</option>
                    <option value="Al Basrah">Al Basrah（阿尔巴士拉）</option>
                    <option value="Fallujah">Fallujah（费卢杰）</option>
                    <option value="Chora">Chora（乔拉）</option>
                    <option value="Narva">Narva（纳尔瓦）</option>
                    <option value="Yehorivka">Yehorivka（叶霍里夫卡）</option>
                    <option value="Kashan Desert">Kashan Desert（卡尚沙漠）</option>
                    <option value="Mestia">Mestia（梅斯蒂亚）</option>
                    <option value="Skorpo">Skorpo（斯科尔波）</option>
                    <option value="Tallil Outskirts">Tallil Outskirts（塔利勒郊区）</option>
                    <option value="Fool's Road">Fool's Road（愚人之路）</option>
                    <option value="Gaza Beach">Gaza Beach（加沙海滩）</option>
                    <option value="Kamdesh">Kamdesh（坎德什）</option>
                    <option value="Lashkar Valley">Lashkar Valley（拉什卡尔山谷）</option>
                    <option value="Manhattan">Manhattan（曼哈顿）</option>
                    <option value="Sinnai">Sinnai（西奈）</option>
                    <option value="Talil Airfield">Talil Airfield（塔利勒机场）</option>
                    <option value="Al Mutrah">Al Mutrah（穆特拉）</option>
                    <option value="Operation Marlin">Operation Marlin（马林行动）</option>
                    <option value="Insurgency">Insurgency（叛乱）</option>
                    <option value="Kargha Castle">Kargha Castle（卡尔加城堡）</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="checkinDate">打卡日期</label>
                <input type="date" id="checkinDate" class="form-input" required>
            </div>
            <button id="checkinBtn" class="checkin-btn">提交打卡</button>
        </div>
        <!-- 历史记录控制 -->
        <div class="record-control">
            <button id="viewRecordBtn" class="view-record-btn">查看打卡历史</button>
            <button id="statBtn" class="stat-btn">统计30天少打卡成员</button>
        </div>
        <!-- 历史记录列表 -->
        <div id="recordList" class="record-list">
            <h3 class="record-title">H战队OP打卡记录（按日期分组）</h3>
            <div id="recordContent"></div>
        </div>
    </div>
    <script>
        // 初始化元素
        const gameNameInput = document.getElementById('gameName');
        const checkinMapSelect = document.getElementById('checkinMap');
        const checkinDateInput = document.getElementById('checkinDate');
        const checkinBtn = document.getElementById('checkinBtn');
        const viewRecordBtn = document.getElementById('viewRecordBtn');
        const statBtn = document.getElementById('statBtn');
        const recordList = document.getElementById('recordList');
        const recordContent = document.getElementById('recordContent');
        // 核心配置：后端接口地址（需与后端服务的 PORT 一致）
        const BACKEND_URL = 'http://localhost:3000/api';
        // 今日日期（YYYY-MM-DD）
        const today = new Date().toISOString().split('T')[0];
        // 页面加载初始化
        function init() {
            // 日期输入框固定为今日，禁止修改
            checkinDateInput.value = today;
            checkinDateInput.disabled = true;
            // 绑定事件
            checkinBtn.addEventListener('click', handleCheckin);
            viewRecordBtn.addEventListener('click', toggleRecordList);
            statBtn.addEventListener('click', statLowCheckinMembers);
            // 加载并渲染所有用户的打卡记录（从后端获取）
            renderRecordsByDate();
        }
        // 1. 处理打卡（调用后端接口提交）
        async function handleCheckin() {
            const gameName = gameNameInput.value.trim();
            const checkinMap = checkinMapSelect.value;
            const checkinDate = today;
            const checkinTime = new Date().toLocaleTimeString(); // 精确到时分秒
            // 前端校验
            if (!gameName) {
                alert('请输入你的游戏名称！');
                return;
            }
            if (!checkinMap) {
                alert('请选择本次OP打卡地图！');
                return;
            }
            try {
                // 调用后端接口提交打卡
                const response = await fetch(`${BACKEND_URL}/checkin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gameName, map: checkinMap, date: checkinDate, time: checkinTime })
                });
                const result = await response.json();
                // 处理响应
                if (result.success) {
                    alert(result.msg);
                    // 重置表单
                    gameNameInput.value = '';
                    checkinMapSelect.value = '';
                    // 重新加载记录（显示最新打卡）
                    renderRecordsByDate();
                } else {
                    alert('打卡失败：' + result.msg);
                }
            } catch (error) {
                alert('打卡失败：无法连接后端服务器，请检查服务是否启动！');
                console.error('打卡错误：', error);
            }
        }
        // 2. 从后端获取所有记录并按日期分组渲染
        async function renderRecordsByDate() {
            try {
                // 调用后端接口获取所有打卡记录
                const response = await fetch(`${BACKEND_URL}/records`);
                const result = await response.json();
                if (!result.success) {
                    recordContent.innerHTML = '<div class="record-item">获取记录失败：' + result.msg + '</div>';
                    return;
                }
                const records = result.data; // 后端返回的所有用户的打卡记录
                // 无记录时显示提示
                if (records.length === 0) {
                    recordContent.innerHTML = '<div class="record-item">暂无打卡记录</div>';
                    return;
                }
                // 按日期倒序排序（最新日期在前）
                records.sort((a, b) => new Date(b.date) - new Date(a.date));
                // 按日期分组
                const dateGroupMap = {};
                records.forEach(record => {
                    if (!dateGroupMap[record.date]) {
                        dateGroupMap[record.date] = [];
                    }
                    dateGroupMap[record.date].push(record);
                });
                // 渲染分组记录
                let groupHtml = '';
                Object.keys(dateGroupMap).forEach(date => {
                    const groupRecords = dateGroupMap[date];
                    // 组内按打卡时间倒序排序
                    groupRecords.sort((a, b) => new Date(`2000-01-01 ${b.time}`) - new Date(`2000-01-01 ${a.time}`));
                    // 拼接 HTML
                    groupHtml += `
                        <div class="date-group">
                            <div class="date-group-header">${formatDate(date)}（共${groupRecords.length}人打卡）</div>
                            <div class="date-group-content">
                                ${groupRecords.map((record, idx) => `
                                    <div class="record-item" onclick="showRecordDetail('${JSON.stringify(record).replace(/'/g, "\\'")}')">
                                        <span class="record-name">${idx + 1}. ${record.gameName}（${record.map}）</span>
                                        <span class="record-time">${record.time}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
                recordContent.innerHTML = groupHtml;
            } catch (error) {
                recordContent.innerHTML = '<div class="record-item">加载记录失败：无法连接后端服务器！</div>';
                console.error('加载记录错误：', error);
            }
        }
        // 3. 统计30天内打卡少于5次的成员（基于后端全量数据）
        async function statLowCheckinMembers() {
            try {
                // 调用后端接口获取所有记录
                const response = await fetch(`${BACKEND_URL}/records`);
                const result = await response.json();
                if (!result.success) {
                    alert('统计失败：' + result.msg);
                    return;
                }
                const allRecords = result.data;
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];
                // 筛选30天内的记录
                const recentRecords = allRecords.filter(record => record.date >= thirtyDaysAgoStr);
                if (recentRecords.length === 0) {
                    alert('30天内暂无打卡记录，无法统计！');
                    return;
                }
                // 统计每个成员的打卡次数
                const memberCheckinCount = {};
                recentRecords.forEach(record => {
                    memberCheckinCount[record.gameName] = (memberCheckinCount[record.gameName] || 0) + 1;
                });
                // 筛选打卡少于5次的成员
                const lowCheckinMembers = Object.entries(memberCheckinCount)
                    .filter(([_, count]) => count < 5)
                    .sort((a, b) => a[1] - b[1]);
                // 生成统计结果
                let statResult = `30天内（${formatDate(thirtyDaysAgoStr)} - ${formatDate(today)}）打卡少于5次的成员：\n\n`;
                if (lowCheckinMembers.length === 0) {
                    statResult += '所有成员30天内打卡次数均≥5次，执行力满分！';
                } else {
                    lowCheckinMembers.forEach(([name, count], idx) => {
                        statResult += `${idx + 1}. ${name}：${count}次\n`;
                    });
                }
                alert(statResult);
            } catch (error) {
                alert('统计失败：无法连接后端服务器！');
                console.error('统计错误：', error);
            }
        }
        // 辅助函数：日期格式转换（YYYY-MM-DD → 年月日）
        function formatDate(dateStr) {
            const [year, month, day] = dateStr.split('-');
            return `${year}年${month}月${day}日`;
        }
        // 辅助函数：显示单条记录详情
        function showRecordDetail(recordStr) {
            const record = JSON.parse(recordStr);
            alert(`
                游戏名称：${record.gameName}
                打卡地图：${record.map}
                打卡日期：${formatDate(record.date)}
                打卡时间：${record.time}
            `);
        }
        // 辅助函数：切换历史记录列表显示/隐藏
        function toggleRecordList() {
            recordList.classList.toggle('show');
            viewRecordBtn.textContent = recordList.classList.contains('show') 
                ? '隐藏打卡历史' 
                : '查看打卡历史';
            // 显示时重新加载记录（确保是最新数据）
            if (recordList.classList.contains('show')) {
                renderRecordsByDate();
            }
        }
        // 全局暴露方法（供HTML中onclick调用）
        window.showRecordDetail = showRecordDetail;
        // 页面加载完成后初始化
        window.onload = init;
    </script>
</body>
</html>// 配置信息（替换为你的GitHub信息！）
const CONFIG = {
    owner: "1035074842",
    repo: "9898",   
    token: "你的GitHub PAT Token", 
    label: "sign-record"      
};

// 1. 提交签到：创建GitHub Issue存储签到数据
async function submitSign() {
    const username = document.getElementById("username").value.trim();
    const remark = document.getElementById("remark").value.trim();
    const signMsg = document.getElementById("signMsg");

    // 表单验证
    if (!username) {
        signMsg.style.color = "red";
        signMsg.textContent = "请输入你的名字/昵称！";
        return;
    }

    // 签到数据（Issue标题和正文用于存储信息）
    const signTime = new Date().toLocaleString("zh-CN", { 
        year: "numeric", month: "2-digit", day: "2-digit", 
        hour: "2-digit", minute: "2-digit" 
    });
    const issueTitle = `[签到记录] ${username} - ${signTime}`;
    const issueBody = `
        **签到人**：${username}  
        **签到时间**：${signTime}  
        **备注**：${remark || "无"}  
    `;

    try {
        // 调用GitHub API创建Issue
        const response = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/issues`, {
            method: "POST",
            headers: {
                "Authorization": `token ${CONFIG.token}`, // 认证Token
                "Accept": "application/vnd.github.v3+json",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                title: issueTitle,
                body: issueBody,
                labels: [CONFIG.label] // 给Issue打标签，方便后续筛选
            })
        });

        if (response.ok) {
            signMsg.style.color = "green";
            signMsg.textContent = "签到成功！记录已保存～";
            // 清空表单并刷新记录
            document.getElementById("username").value = "";
            document.getElementById("remark").value = "";
            loadSignRecords(); // 刷新历史记录
        } else {
            const error = await response.json();
            throw new Error(error.message);
        }
    } catch (err) {
        signMsg.style.color = "red";
        signMsg.textContent = `签到失败：${err.message}`;
    }
}

// 2. 加载历史签到记录：读取所有带“sign-record”标签的Issue
async function loadSignRecords() {
    const recordsList = document.getElementById("recordsList");
    recordsList.innerHTML = "正在加载历史记录...";

    try {
        // 调用GitHub API筛选标签为“sign-record”的Issue（按创建时间倒序）
        const response = await fetch(
            `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/issues?labels=${CONFIG.label}&sort=created&direction=desc`,
            {
                headers: {
                    "Accept": "application/vnd.github.v3+json",
                    // 非创建操作可不用Token，但认证后速率限制更高（未认证每小时60次，认证后5000次）
                    "Authorization": `token ${CONFIG.token}`
                }
            }
        );

        if (response.ok) {
            const issues = await response.json();
            if (issues.length === 0) {
                recordsList.innerHTML = "暂无签到记录～";
                return;
            }

            // 渲染签到记录
            let html = "";
            issues.forEach((issue, index) => {
                // 解析Issue正文中的签到信息（也可直接用issue.title和issue.created_at）
                const match = issue.body.match(/\*\*签到人\*\*：(.*?)\s+\*\*签到时间\*\*：(.*?)\s+\*\*备注\*\*：(.*?)\s+/);
                const name = match ? match[1] : "未知用户";
                const time = match ? match[2] : new Date(issue.created_at).toLocaleString("zh-CN");
                const remark = match ? match[3] : "无";

                html += `
                    <div class="record-item">
                        <p><strong>${index + 1}. 签到人</strong>：${name}</p>
                        <p><strong>时间</strong>：${time}</p>
                        <p><strong>备注</strong>：${remark}</p>
                        <p style="font-size: 12px; color: #666;">
                            记录链接：<a href="${issue.html_url}" target="_blank">查看原始记录</a>
                        </p>
                    </div>
                `;
            });
            recordsList.innerHTML = html;
        } else {
            const error = await response.json();
            throw new Error(error.message);
        }
    } catch (err) {
        recordsList.innerHTML = `加载失败：${err.message}`;
    }
}

// 页面加载时自动加载历史记录

window.onload = loadSignRecords;
